# LinCMS Nginx CORS 配置示例
#
# 此文件包含完整的 Nginx 配置，用于解决前后端跨域问题
#
# 功能特性：
# - ✅ 支持所有必要的 CORS 请求头
# - ✅ 允许 'tag' 请求头（验证码签名）
# - ✅ 允许 'X-Request-Id' 请求头
# - ✅ 正确处理 OPTIONS 预检请求
# - ✅ 支持 WebSocket
# - ✅ SSL/HTTPS 支持
#
# 使用方法：
# 1. 备份当前配置：sudo cp /etc/nginx/sites-available/current.conf /etc/nginx/sites-available/current.conf.backup
# 2. 复制此文件：sudo cp nginx.conf.example /etc/nginx/sites-available/lincms
# 3. 测试配置：sudo nginx -t
# 4. 重载配置：sudo nginx -s reload
#
# 注意事项：
# - 请根据实际情况修改 server_name、root、proxy_pass 等配置
# - 前端地址：http://localhost:8080（lin-cms-vue）
# - 后端地址：http://127.0.0.1:5000（lin-cms-dotnetcore）
#
# 更多信息请参阅：../CLAUDE.md 部署注意事项章节

server {
    listen 80;
    listen 443 ssl;
    server_name api.okyu.xyz;
    index index.php index.html index.htm default.php default.htm default.html;
    access_log /www/sites/api.okyu.xyz/log/access.log main;
    error_log /www/sites/api.okyu.xyz/log/error.log;

    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md) {
        return 404;
    }

    location ^~ /.well-known/acme-challenge {
        allow all;
        root /usr/share/nginx/html;
    }

    if ( $uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403;
    }

    root /www/sites/api.okyu.xyz/index;
    http2 on;

    if ($scheme = http) {
        return 301 https://$host$request_uri;
    }

    ssl_certificate /www/sites/api.okyu.xyz/ssl/fullchain.pem;
    ssl_certificate_key /www/sites/api.okyu.xyz/ssl/privkey.pem;
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:!aNULL:!eNULL:!EXPORT:!DSS:!DES:!RC4:!3DES:!MD5:!PSK:!KRB5:!SRP:!CAMELLIA:!SEED;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    error_page 497 https://$host$request_uri;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    add_header Strict-Transport-Security "max-age=31536000";

    # 完整 CORS 配置：包含所有需要的请求头
    location / {
        # CORS 头部设置（包含 tag 请求头）
        add_header Access-Control-Allow-Origin "http://localhost:8080" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Requested-With,Accept,Origin,Accept-Encoding,Accept-Language,Connection,Content-Length,tag,X-Request-Id" always;
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range,Authorization,X-Request-Id" always;

        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "http://localhost:8080" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS, HEAD" always;
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,X-Requested-With,Accept,Origin,Accept-Encoding,Accept-Language,Connection,Content-Length,tag,X-Request-Id" always;
            add_header Access-Control-Max-Age "1728000" always;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length "0";
            return 204;
        }

        # 代理到后端
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 禁用缓冲
        proxy_buffering off;
    }
}
